From 604f16b22f754741c8ac7a9b7dc13a97d3e0a15f Mon Sep 17 00:00:00 2001
From: "H. Vetinari" <h.vetinari@gmx.com>
Date: Mon, 1 Jul 2024 09:34:14 +1100
Subject: [PATCH 5/6] move zoneinfo_file function into __gnu_cxx namespace

---
 libstdc++-v3/config/abi/pre/gnu.ver |  1 +
 libstdc++-v3/src/c++20/tzdb.cc      | 55 ++++++++++++++---------------
 2 files changed, 28 insertions(+), 28 deletions(-)

diff --git a/libstdc++-v3/config/abi/pre/gnu.ver b/libstdc++-v3/config/abi/pre/gnu.ver
index 31449b5b8..3cfa009a8 100644
--- a/libstdc++-v3/config/abi/pre/gnu.ver
+++ b/libstdc++-v3/config/abi/pre/gnu.ver
@@ -2506,6 +2506,7 @@ GLIBCXX_3.4.31 {
     _ZNSt6chrono9tzdb_list14const_iteratorppEv;
     _ZNSt6chrono9tzdb_list14const_iteratorppEi;
     _ZN9__gnu_cxx21zoneinfo_dir_overrideEv;
+    _ZN9__gnu_cxx13zoneinfo_fileB5cxx11ESt17basic_string_viewIcSt11char_traitsIcEE;
 
     # __shared_ptr<directory_iterator::_Dir>::operator bool()
     _ZNKSt12__shared_ptrINSt10filesystem4_DirELN9__gnu_cxx12_Lock_policyE[012]EEcvbEv;
diff --git a/libstdc++-v3/src/c++20/tzdb.cc b/libstdc++-v3/src/c++20/tzdb.cc
index 5389a9c12..2dfce6326 100644
--- a/libstdc++-v3/src/c++20/tzdb.cc
+++ b/libstdc++-v3/src/c++20/tzdb.cc
@@ -133,6 +133,29 @@ namespace __gnu_cxx
     return nullptr;
 #endif
   }
+
+  // If a zoneinfo directory is defined (either when the library was built,
+  // or via the zoneinfo_dir_override function) then append filename to it.
+  // The filename should have a leading '/' as one is not added explicitly.
+  std::string zoneinfo_file(std::string_view filename)
+  {
+    std::string path;
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Waddress"
+    if (zoneinfo_dir_override)
+    {
+      if (auto override_dir = zoneinfo_dir_override())
+        path = override_dir;
+#pragma GCC diagnostic pop
+    }
+#ifdef _GLIBCXX_ZONEINFO_DIR
+    else
+      path = _GLIBCXX_ZONEINFO_DIR;
+#endif
+    if (!path.empty())
+      path.append(filename);
+    return path;
+  }
 }
 
 #if ! defined _GLIBCXX_ZONEINFO_DIR && ! defined _GLIBCXX_STATIC_TZDATA
@@ -1109,30 +1132,6 @@ namespace std::chrono
 #ifndef TZDB_DISABLED
   namespace
   {
-    // If a zoneinfo directory is defined (either when the library was built,
-    // or via the zoneinfo_dir_override function) then append filename to it.
-    // The filename should have a leading '/' as one is not added explicitly.
-    string
-    zoneinfo_file(string_view filename)
-    {
-      string path;
-#pragma GCC diagnostic push
-#pragma GCC diagnostic ignored "-Waddress"
-      if (__gnu_cxx::zoneinfo_dir_override)
-      {
-	if (auto override_dir = __gnu_cxx::zoneinfo_dir_override())
-	  path = override_dir;
-#pragma GCC diagnostic pop
-      }
-#ifdef _GLIBCXX_ZONEINFO_DIR
-      else
-	path = _GLIBCXX_ZONEINFO_DIR;
-#endif
-      if (!path.empty())
-	path.append(filename);
-      return path;
-    }
-
     // N.B. Leading slash as required by zoneinfo_file function.
     const string_view tzdata_file = "/tzdata.zi";
     const string_view leaps_file = "/leapseconds";
@@ -1166,7 +1165,7 @@ namespace std::chrono
 
       tzdata_stream() : istream(nullptr)
       {
-	if (string path = zoneinfo_file(tzdata_file); !path.empty())
+	if (string path = __gnu_cxx::zoneinfo_file(tzdata_file); !path.empty())
 	{
 	  filebuf fbuf;
 	  if (fbuf.open(path, std::ios::in))
@@ -1234,7 +1233,7 @@ namespace std::chrono
 #endif
 
 #ifndef TZDB_DISABLED
-    if (ifstream ls{zoneinfo_file(leaps_file)})
+    if (ifstream ls{__gnu_cxx::zoneinfo_file(leaps_file)})
       {
 	auto exp_year = year_month_day(expires).year();
 	std::string s, w;
@@ -1298,12 +1297,12 @@ namespace std::chrono
 	  return version;
 #if 0 // Ignore these files, because we're not using them anyway.
 #if defined __NetBSD__
-      if (string ver; ifstream(zoneinfo_file("/TZDATA_VERSION")) >> ver)
+      if (string ver; ifstream(__gnu_cxx::zoneinfo_file("/TZDATA_VERSION")) >> ver)
 	return ver;
 #elif defined __APPLE__
       // The standard install on macOS has no tzdata.zi, but we can find the
       // version from +VERSION.
-      if (string ver; ifstream(zoneinfo_file("/+VERSION")) >> ver)
+      if (string ver; ifstream(__gnu_cxx::zoneinfo_file("/+VERSION")) >> ver)
 	return ver;
 #endif
 #endif
