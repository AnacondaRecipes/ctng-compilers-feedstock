From d0c164c89a6ff1742484139a1253f50cd2d75b98 Mon Sep 17 00:00:00 2001
From: "H. Vetinari" <h.vetinari@gmx.com>
Date: Tue, 4 Jun 2024 09:47:29 +1100
Subject: [PATCH 4/4] patch zoneinfo_dir_override to point to our tzdata

---
 libstdc++-v3/src/c++20/tzdb.cc | 21 +++++++++++++--------
 1 file changed, 13 insertions(+), 8 deletions(-)

diff --git a/libstdc++-v3/src/c++20/tzdb.cc b/libstdc++-v3/src/c++20/tzdb.cc
index c7c7cc9de..16d6744e0 100644
--- a/libstdc++-v3/src/c++20/tzdb.cc
+++ b/libstdc++-v3/src/c++20/tzdb.cc
@@ -37,9 +37,7 @@
 #include <mutex>      // mutex
 #include <filesystem> // filesystem::read_symlink
 
-#ifndef _AIX
 # include <cstdlib>   // getenv
-#endif
 
 #if defined __GTHREADS && ATOMIC_POINTER_LOCK_FREE == 2
 # define USE_ATOMIC_LIST_HEAD 1
@@ -68,13 +66,21 @@ namespace __gnu_cxx
   // Cannot override weak symbols on AIX.
   const char* (*zoneinfo_dir_override)() = nullptr;
 #else
-  [[gnu::weak]] const char* zoneinfo_dir_override();
-
-#if defined(__APPLE__) || defined(__hpux__) \
-  || (defined(__VXWORKS__) && !defined(__RTP__))
-  // Need a weak definition for Mach-O et al.
   [[gnu::weak]] const char* zoneinfo_dir_override()
   {
+    // at run-time, use CONDA_PREFIX
+    const char* conda_prefix = getenv("CONDA_PREFIX");
+    // at build-time (i.e. CONDA_BUILD is set), use PREFIX
+    const char* in_conda_build = getenv("CONDA_BUILD");
+    if (in_conda_build && *in_conda_build == '1') {
+      conda_prefix = getenv("PREFIX");
+    }
+    if (conda_prefix) {
+      // <string> is included through <chrono>
+      std::string tz_dir(conda_prefix);
+      tz_dir += "/share/zoneinfo";
+      return tz_dir.c_str();
+    }
 #ifdef _GLIBCXX_ZONEINFO_DIR
     return _GLIBCXX_ZONEINFO_DIR;
 #else
@@ -82,7 +88,6 @@ namespace __gnu_cxx
 #endif
   }
 #endif
-#endif
 }
 
 #if ! defined _GLIBCXX_ZONEINFO_DIR && ! defined _GLIBCXX_STATIC_TZDATA
